name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.11'
  # Test environment variables (dummy values for CI)
  AZURE_CLIENT_ID: test-client-id
  AZURE_CLIENT_SECRET: test-client-secret
  AZURE_TENANT_ID: test-tenant-id
  SECRET_KEY: test-secret-key-for-ci-only-not-secure

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      working-directory: ./backend
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -e ".[dev]"
    
    - name: Run tests
      working-directory: ./backend
      env:
        # Enable test mode to skip MSAL initialization
        TESTING: "true"
        # Override with test values
        AZURE_CLIENT_ID: ${{ env.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ env.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ env.AZURE_TENANT_ID }}
        SECRET_KEY: ${{ env.SECRET_KEY }}
      run: |
        source .venv/bin/activate
        pytest --cov=app --cov-report=xml --cov-report=term
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        fail_ci_if_error: false
  
  deploy:
    name: Deploy to Azure
    needs: build-and-test
    runs-on: ubuntu-latest
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      working-directory: ./backend
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -e .
    
    - name: Create deployment package
      run: |
        # Copy backend files
        mkdir -p deploy
        cp -r backend/app deploy/
        cp backend/pyproject.toml deploy/
        cp backend/requirements.txt deploy/
        
        # Copy frontend files (served by FastAPI)
        cp -r frontend deploy/
        
        # Create data directories
        mkdir -p deploy/data/requests
        mkdir -p deploy/data/backups
        
        # Create startup script for Azure
        cat > deploy/startup.sh << 'EOF'
        #!/bin/bash
        
        # Install uv if not present
        if ! command -v uv &> /dev/null; then
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.cargo/bin:$PATH"
        fi
        
        # Install dependencies
        uv pip install --system -r requirements.txt
        
        # Start uvicorn
        uvicorn app.main:app --host 0.0.0.0 --port 8000
        EOF
        chmod +x deploy/startup.sh
    
    - name: Deploy to Azure Web App
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./deploy
    
    - name: Health Check
      run: |
        echo "Waiting for deployment to complete..."
        sleep 30
        
        # Check health endpoint
        HEALTH_URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
        echo "Checking health at: $HEALTH_URL"
        
        for i in {1..10}; do
          if curl -f -s "$HEALTH_URL" > /dev/null; then
            echo "âœ… Health check passed!"
            exit 0
          fi
          echo "Attempt $i failed, retrying in 10 seconds..."
          sleep 10
        done
        
        echo "âŒ Health check failed after 10 attempts"
        exit 1
    
    - name: Deployment Summary
      if: success()
      run: |
        echo "ğŸš€ Deployment successful!"
        echo "ğŸ“ Application URL: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "ğŸ¥ Health: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
        echo "ğŸ“š API Docs: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/docs"